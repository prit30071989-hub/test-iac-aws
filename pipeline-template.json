{
  "AWSTemplateFormatVersion": "2010-09-09",
  "Description": "CodePipeline (GitHub -> CodeBuild -> CloudFormation) with artifact bucket and roles.",
  "Parameters": {
    "RepositoryOwner": {
      "Type": "String",
      "Description": "GitHub owner or org (e.g., my-org)"
    },
    "RepositoryName": {
      "Type": "String",
      "Description": "GitHub repository name (e.g., my-repo)"
    },
    "BranchName": {
      "Type": "String",
      "Default": "main",
      "Description": "Branch to track"
    },
    "CodeStarConnectionArn": {
      "Type": "String",
      "Description": "ARN of an existing CodeStar Connection to GitHub (v2)"
    },
    "StackName": {
      "Type": "String",
      "Default": "infra-core",
      "Description": "Target CloudFormation stack name to deploy"
    },
    "BuildImage": {
      "Type": "String",
      "Default": "aws/codebuild/standard:6.0",
      "Description": "CodeBuild Docker image"
    },
    "BuildComputeType": {
      "Type": "String",
      "Default": "BUILD_GENERAL1_SMALL",
      "AllowedValues": [
        "BUILD_GENERAL1_SMALL",
        "BUILD_GENERAL1_MEDIUM",
        "BUILD_GENERAL1_LARGE"
      ],
      "Description": "CodeBuild compute size"
    }
  },
  "Resources": {
    "ArtifactBucket": {
      "Type": "AWS::S3::Bucket",
      "Properties": {
        "VersioningConfiguration": {
          "Status": "Enabled"
        },
        "PublicAccessBlockConfiguration": {
          "BlockPublicAcls": true,
          "BlockPublicPolicy": true,
          "IgnorePublicAcls": true,
          "RestrictPublicBuckets": true
        },
        "BucketEncryption": {
          "ServerSideEncryptionConfiguration": [
            {
              "ServerSideEncryptionByDefault": {
                "SSEAlgorithm": "AES256"
              }
            }
          ]
        }
      }
    },
    "PipelineRole": {
      "Type": "AWS::IAM::Role",
      "Properties": {
        "AssumeRolePolicyDocument": {
          "Version": "2012-10-17",
          "Statement": [
            {
              "Effect": "Allow",
              "Principal": {
                "Service": [
                  "codepipeline.amazonaws.com"
                ]
              },
              "Action": [
                "sts:AssumeRole"
              ]
            }
          ]
        },
        "Policies": [
          {
            "PolicyName": "CodePipelineInline",
            "PolicyDocument": {
              "Version": "2012-10-17",
              "Statement": [
                {
                  "Effect": "Allow",
                  "Resource": [
                    {
                      "Fn::Sub": "arn:${AWS::Partition}:s3:::${ArtifactBucket}"
                    },
                    {
                      "Fn::Sub": "arn:${AWS::Partition}:s3:::${ArtifactBucket}/*"
                    }
                  ],
                  "Action": [
                    "s3:GetObject",
                    "s3:GetObjectVersion",
                    "s3:PutObject",
                    "s3:ListBucket"
                  ]
                },
                {
                  "Effect": "Allow",
                  "Resource": "*",
                  "Action": [
                    "codebuild:BatchGetBuilds",
                    "codebuild:StartBuild"
                  ]
                },
                {
                  "Effect": "Allow",
                  "Resource": [
                    {
                      "Ref": "CodeStarConnectionArn"
                    }
                  ],
                  "Action": [
                    "codestar-connections:UseConnection"
                  ]
                },
                {
                  "Effect": "Allow",
                  "Resource": "*",
                  "Action": [
                    "cloudformation:CreateStack",
                    "cloudformation:UpdateStack",
                    "cloudformation:CreateChangeSet",
                    "cloudformation:ExecuteChangeSet",
                    "cloudformation:DeleteChangeSet",
                    "cloudformation:Describe*"
                  ]
                },
                {
                  "Effect": "Allow",
                  "Resource": [
                    {
                      "Fn::GetAtt": [
                        "CloudFormationRole",
                        "Arn"
                      ]
                    }
                  ],
                  "Condition": {
                    "StringEquals": {
                      "iam:PassedToService": "cloudformation.amazonaws.com"
                    }
                  },
                  "Action": [
                    "iam:PassRole"
                  ]
                }
              ]
            }
          }
        ]
      }
    },
    "BuildProject": {
      "Type": "AWS::CodeBuild::Project",
      "Properties": {
        "Name": {
          "Fn::Sub": "${AWS::StackName}-build"
        },
        "ServiceRole": {
          "Fn::GetAtt": [
            "CodeBuildRole",
            "Arn"
          ]
        },
        "Artifacts": {
          "Type": "CODEPIPELINE"
        },
        "Source": {
          "Type": "CODEPIPELINE"
        },
        "Environment": {
          "Type": "LINUX_CONTAINER",
          "Image": {
            "Ref": "BuildImage"
          },
          "ComputeType": {
            "Ref": "BuildComputeType"
          },
          "PrivilegedMode": false,
          "EnvironmentVariables": [
            {
              "Name": "STACK_NAME",
              "Type": "PLAINTEXT",
              "Value": {
                "Ref": "StackName"
              }
            }
          ]
        },
        "TimeoutInMinutes": 30
      }
    },
    "Pipeline": {
      "Type": "AWS::CodePipeline::Pipeline",
      "Properties": {
        "Name": {
          "Fn::Sub": "${AWS::StackName}"
        },
        "RoleArn": {
          "Fn::GetAtt": [
            "PipelineRole",
            "Arn"
          ]
        },
        "ArtifactStore": {
          "Type": "S3",
          "Location": {
            "Ref": "ArtifactBucket"
          }
        },
        "RestartExecutionOnUpdate": true,
        "Stages": [
          {
            "Name": "Source",
            "Actions": [
              {
                "Name": "GitHub_Source",
                "ActionTypeId": {
                  "Category": "Source",
                  "Owner": "AWS",
                  "Provider": "CodeStarSourceConnection",
                  "Version": "1"
                },
                "Configuration": {
                  "ConnectionArn": {
                    "Ref": "CodeStarConnectionArn"
                  },
                  "FullRepositoryId": {
                    "Fn::Sub": "${RepositoryOwner}/${RepositoryName}"
                  },
                  "BranchName": {
                    "Ref": "BranchName"
                  },
                  "OutputArtifactFormat": "CODE_ZIP"
                },
                "OutputArtifacts": [
                  {
                    "Name": "SourceOutput"
                  }
                ],
                "RunOrder": 1
              }
            ]
          },
          {
            "Name": "Build",
            "Actions": [
              {
                "Name": "Cfn_Lint_Validate",
                "ActionTypeId": {
                  "Category": "Build",
                  "Owner": "AWS",
                  "Provider": "CodeBuild",
                  "Version": "1"
                },
                "Configuration": {
                  "ProjectName": {
                    "Ref": "BuildProject"
                  }
                },
                "InputArtifacts": [
                  {
                    "Name": "SourceOutput"
                  }
                ],
                "OutputArtifacts": [
                  {
                    "Name": "BuildOutput"
                  }
                ],
                "RunOrder": 1
              }
            ]
          },
          {
            "Name": "Deploy",
            "Actions": [
              {
                "Name": "CFN_Deploy",
                "ActionTypeId": {
                  "Category": "Deploy",
                  "Owner": "AWS",
                  "Provider": "CloudFormation",
                  "Version": "1"
                },
                "Configuration": {
                  "ActionMode": "CREATE_UPDATE",
                  "StackName": {
                    "Ref": "StackName"
                  },
                  "Capabilities": "CAPABILITY_NAMED_IAM",
                  "TemplatePath": "SourceOutput::infra/infra-template.json",
                  "RoleArn": {
                    "Fn::GetAtt": [
                      "CloudFormationRole",
                      "Arn"
                    ]
                  }
                },
                "InputArtifacts": [
                  {
                    "Name": "SourceOutput"
                  }
                ],
                "RunOrder": 1
              }
            ]
          }
        ]
      }
    },
    "CodeBuildRole": {
      "Properties": {
        "AssumeRolePolicyDocument": {
          "Version": "2012-10-17",
          "Statement": [
            {
              "Effect": "Allow",
              "Principal": {
                "Service": [
                  "codebuild.amazonaws.com"
                ]
              },
              "Action": [
                "sts:AssumeRole"
              ]
            }
          ]
        },
        "Policies": [
          {
            "PolicyDocument": {
              "Version": "2012-10-17",
              "Statement": [
                {
                  "Effect": "Allow",
                  "Resource": [
                    {
                      "Fn::Sub": "arn:${AWS::Partition}:s3:::${ArtifactBucket}"
                    },
                    {
                      "Fn::Sub": "arn:${AWS::Partition}:s3:::${ArtifactBucket}/*"
                    }
                  ],
                  "Action": [
                    "s3:GetObject",
                    "s3:GetObjectVersion",
                    "s3:PutObject",
                    "s3:ListBucket"
                  ]
                },
                {
                  "Effect": "Allow",
                  "Resource": "*",
                  "Action": [
                    "logs:CreateLogGroup",
                    "logs:CreateLogStream",
                    "logs:PutLogEvents"
                  ]
                },
                {
                  "Effect": "Allow",
                  "Resource": "*",
                  "Action": [
                    "cloudformation:ValidateTemplate"
                  ]
                }
              ]
            },
            "PolicyName": "CodeBuildInline"
          }
        ]
      },
      "Type": "AWS::IAM::Role"
    },
    "CloudFormationRole": {
      "Properties": {
        "AssumeRolePolicyDocument": {
          "Version": "2012-10-17",
          "Statement": [
            {
              "Effect": "Allow",
              "Principal": {
                "Service": [
                  "cloudformation.amazonaws.com"
                ]
              },
              "Action": [
                "sts:AssumeRole"
              ]
            }
          ]
        },
        "Policies": [
          {
            "PolicyDocument": {
              "Version": "2012-10-17",
              "Statement": [
                {
                  "Effect": "Allow",
                  "Resource": "*",
                  "Action": [
                    "s3:*"
                  ]
                }
              ]
            },
            "PolicyName": "CloudFormationDeployInline"
          }
        ]
      },
      "Type": "AWS::IAM::Role"
    }
  },
  "Outputs": {
    "PipelineName": {
      "Value": {
        "Ref": "Pipeline"
      }
    },
    "ArtifactBucketName": {
      "Value": {
        "Ref": "ArtifactBucket"
      }
    }
  }
}